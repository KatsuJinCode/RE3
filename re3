#!/usr/bin/env bash
# RE3 CLI - Simple commands for RE3 experiment collaboration
# Usage: ./re3 <command>

set -e
REPO="KatsuJinCode/RE3"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

show_help() {
    echo "RE3 - Collaborative LLM Testing"
    echo ""
    echo "Commands:"
    echo "  run         Run one experiment slice"
    echo "  run-all     Run until all slices complete"
    echo "  status      Show experiment progress"
    echo "  request     Request collaborator access"
    echo "  approve     (Owner only) Approve a collaborator"
    echo "  pull-data   (Owner only) Pull data files from a PR"
    echo ""
    echo "Setup:"
    echo "  setup       Install dependencies"
    echo "  check       Check if everything is ready"
}

cmd_run() {
    cd "$SCRIPT_DIR"
    python bootstrap.py run
}

cmd_run_all() {
    cd "$SCRIPT_DIR"
    python bootstrap.py run-all
}

cmd_status() {
    cd "$SCRIPT_DIR"
    python bootstrap.py status
    echo ""
    python harness/progress.py status 2>/dev/null || true
}

cmd_setup() {
    cd "$SCRIPT_DIR"
    python bootstrap.py setup
}

cmd_check() {
    cd "$SCRIPT_DIR"
    python bootstrap.py status
}

cmd_request() {
    echo "=== Request Collaborator Access ==="
    echo ""

    # Get GitHub username
    GH_USER=$(gh api user --jq '.login' 2>/dev/null || echo "")
    if [ -z "$GH_USER" ]; then
        echo "Error: Not logged into GitHub CLI (gh)."
        echo "Run: gh auth login"
        exit 1
    fi

    echo "Your GitHub username: $GH_USER"
    echo ""
    echo "This will create an issue requesting collaborator access."
    read -p "Continue? [y/N] " -n 1 -r
    echo ""

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi

    # Create issue
    ISSUE_TITLE="Collaborator Request: $GH_USER"
    ISSUE_BODY="**Username:** $GH_USER

I'd like to help run RE3 experiments.

**My setup:**
- OS: $(uname -s 2>/dev/null || echo "Windows")
- Has LM Studio: (please confirm)
- Available GPU: (please describe)

---
*To approve, repo owner runs:* \`./re3 approve $GH_USER\`"

    gh issue create --repo "$REPO" --title "$ISSUE_TITLE" --body "$ISSUE_BODY"

    echo ""
    echo "Request submitted! The repo owner will be notified."
    echo "Once approved, you can run: ./re3 run"
}

cmd_approve() {
    if [ -z "$1" ]; then
        echo "Usage: ./re3 approve <github-username>"
        echo ""
        echo "Pending requests:"
        gh issue list --repo "$REPO" --search "Collaborator Request" --state open
        exit 1
    fi

    USERNAME="$1"
    echo "Adding $USERNAME as collaborator to $REPO..."

    gh api --method PUT "repos/$REPO/collaborators/$USERNAME" -f permission=push

    echo "Done! $USERNAME can now push to the repo."
    echo ""
    echo "Closing related issues..."

    # Close the request issue
    ISSUE_NUM=$(gh issue list --repo "$REPO" --search "Collaborator Request: $USERNAME" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
    if [ -n "$ISSUE_NUM" ]; then
        gh issue close "$ISSUE_NUM" --repo "$REPO" --comment "Approved! Welcome to RE3."
    fi
}

cmd_pull_data() {
    if [ -z "$1" ]; then
        echo "Usage: ./re3 pull-data <PR_NUMBER>"
        echo ""
        echo "Open PRs with data:"
        gh pr list --repo "$REPO" --search "Complete" --state open
        exit 1
    fi

    PR_NUM="$1"
    echo "=== Pull Data from PR #$PR_NUM ==="

    cd "$SCRIPT_DIR"

    # Get PR info
    PR_INFO=$(gh pr view "$PR_NUM" --repo "$REPO" --json headRefName,headRepository,headRepositoryOwner,title 2>/dev/null)
    if [ -z "$PR_INFO" ]; then
        echo "Error: Could not fetch PR #$PR_NUM"
        exit 1
    fi

    PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
    HEAD_REF=$(echo "$PR_INFO" | jq -r '.headRefName')
    HEAD_OWNER=$(echo "$PR_INFO" | jq -r '.headRepositoryOwner.login')
    HEAD_REPO=$(echo "$PR_INFO" | jq -r '.headRepository.name')

    echo "PR: $PR_TITLE"
    echo "From: $HEAD_OWNER/$HEAD_REPO @ $HEAD_REF"
    echo ""

    # Add remote if needed
    REMOTE_NAME="contrib-$HEAD_OWNER"
    if ! git remote get-url "$REMOTE_NAME" &>/dev/null; then
        echo "Adding remote $REMOTE_NAME..."
        git remote add "$REMOTE_NAME" "https://github.com/$HEAD_OWNER/$HEAD_REPO.git"
    fi

    # Fetch the branch
    echo "Fetching $HEAD_REF..."
    git fetch "$REMOTE_NAME" "$HEAD_REF"

    # Checkout only data files
    echo "Extracting data files..."
    git checkout "$REMOTE_NAME/$HEAD_REF" -- data/runs/ 2>/dev/null || true
    git checkout "$REMOTE_NAME/$HEAD_REF" -- data/summaries/ 2>/dev/null || true
    git checkout "$REMOTE_NAME/$HEAD_REF" -- progress.json 2>/dev/null || true

    # Check if anything changed
    if git diff --quiet && ! git diff --cached --quiet; then
        : # staged changes exist, continue
    elif git diff --quiet && git diff --cached --quiet; then
        echo "No new data files to pull."
        exit 0
    fi

    # Validate JSONL files (basic check)
    echo "Validating data..."
    INVALID=0
    for f in $(git diff --name-only HEAD | grep '\.jsonl$' || true); do
        if [ -f "$f" ]; then
            if ! python -c "
import sys, json
with open('$f') as fh:
    for i, line in enumerate(fh, 1):
        if line.strip():
            try:
                json.loads(line)
            except json.JSONDecodeError as e:
                print(f'  Line {i}: {e}')
                sys.exit(1)
" 2>/dev/null; then
                echo "  Invalid JSON in $f"
                INVALID=1
            fi
        fi
    done

    if [ "$INVALID" -eq 1 ]; then
        echo "Validation failed. Aborting."
        git checkout HEAD -- data/ progress.json
        exit 1
    fi
    echo "  OK"

    # Stage and commit
    git add data/runs/ data/summaries/ progress.json
    git commit -m "Data from PR #$PR_NUM: $PR_TITLE"

    echo ""
    echo "Data merged successfully!"
    echo ""

    # Comment and close PR
    read -p "Close PR #$PR_NUM? [Y/n] " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        gh pr close "$PR_NUM" --repo "$REPO" --comment "Data merged via \`re3 pull-data\`. Thank you!"
        echo "PR closed."
    fi
}

# Main dispatch
case "${1:-help}" in
    run)       cmd_run ;;
    run-all)   cmd_run_all ;;
    status)    cmd_status ;;
    setup)     cmd_setup ;;
    check)     cmd_check ;;
    request)   cmd_request ;;
    approve)   cmd_approve "$2" ;;
    pull-data) cmd_pull_data "$2" ;;
    help|--help|-h) show_help ;;
    *)
        echo "Unknown command: $1"
        echo "Run './re3 help' for usage."
        exit 1
        ;;
esac
